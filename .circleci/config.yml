version: 2.1
orbs:
  docker: circleci/docker@2.4.0
  cypress: cypress-io/cypress@3.1.4
jobs:
  lint:
    docker:
      - image: cimg/node:18.12
    steps:
      - checkout
      - run:
          name: Install packages
          command: npm install -D
      - run:
          name: Run lint
          command: npm run lint
workflows:
  lint-cy-build-deploy:
    jobs:
      - lint:
          filters:
            branches:
              only: master
      - cypress/run:
          install-browsers: true
          start-command: "npm run dev"
          cypress-command: "npx cypress run --browser chrome --config baseUrl=http://localhost:5173"
          filters:
            branches:
              only: master
      - docker/publish:
          image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          tag: $CIRCLE_SHA1,latest
          update-description: true
          requires:
            - lint
            - cypress/run
          filters:
            branches:
              only: master
  lint-cy-build:
    jobs:
      - lint:
          filters:
            branches:
              ignore: master
      - cypress/run:
          install-browsers: true
          start-command: "npm run dev"
          cypress-command: "npx wait-on@latest http://localhost:5173 && npx cypress run --browser chrome --config baseUrl=http://localhost:5173"
          filters:
            branches:
              ignore: master
      - docker/publish:
          image: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          deploy: false
          requires:
            - lint
            - cypress/run
          filters:
            branches:
              ignore: master
